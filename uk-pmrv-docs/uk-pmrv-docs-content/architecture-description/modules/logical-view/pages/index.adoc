= Logical view

Breaking down UK PMRV, we identify the following software artifacts:

- PMRV Web App
- PMRV API
- Identity Manager
- ClamAV
- PMRV Admin
- Static pages

image::achitecture-diagram.png[]

Decomposing this diagram we identify the following containers or 3rd party software systems.

== PMRV Web App
The PMRV Web App is a Single Page Application (SPA) implemented using Angular and Typescript. Behind the scenes, the application uses a JS library to connect with the IDM and renewing the user token. When needed, this SPA communicates with the backend services using HTTPS requests.

This web app connects to the following backend components:
- the PMRV API for retrieving and performing business critical operations
- the Identity Manager for authenticating and authorizing users


== PMRV API
The PMRV API is a JAVA/SpringBoot application which utilises the @RestController annotation and provides a set of HTTP endpoints that the PMRV Web App can access.

This component connects to the following components:

- the PMRV Database for storing business information
- the Identity manager for verifying security tokens and performing user based operations

The following component diagram provides more information:

=== Component diagram

image::uk-pmrv-component-diagram.png[]

Drilling into the details of the component diagrams we are presented with the following high level structure:

=== Security layers
There are two security layers (implemented by two separate security mechanisms). The first is based on Keycloak Oath2 implementation and protects the application at the API level.

Keycloak provides a library that is used to intercept all HTTP calls according to the API that is used. According to Oath2, all HTTP requests must contain a token generated by the IDM. This taken (also known as the bearer token) is then processed and verified using Keycloak.

The second mechanism is a custom-made authorisation engine that protects specific API endpoints in the source code.

For more information on security matters please refer to xref:non-functional-view:security.adoc[Security].

=== Controllers
Authenticated HTTP(S) (or in the process of operator user registration, unauthenticated) requests will eventually reach the REST Controller. Controllers implement the behaviour of the server by calling methods from services.

=== Domain Services
Services are Spring beans that implement the business logic of a specific domain of the system. Typically, one controller will use the related service. Many times, a Service can use the functionality of another Service.

=== Orchestration Layer
There are cases where the functionality required by an endpoint is spread across many business domains. This layer implements the orchestration of the service calls and handles the transacrion boundaries.

=== Domain Repositories
Repositories are responsible for storing and retrieving data from the database. Typically, they relate to a single database entity but in some cases they may perform more complex queries.

=== Database
The PMRV uses the PostgreSQL RDBMS. It contains all the necessary tables to support the business data models.

For more information on the table structure please refer to the xref:data-view:index.adoc[Data view].

== Identity Manager
Keycloak is an open source 3rd party software by RedHat, that is used as the identity manager of the system. It relies on its own database for storage of realm and users  configuration.

The presentation theme is customised to comply with the GDS standard.

The component provides a number of Service Provider Interfaces (SPI), allowing the implementation of custom providers in order to extend the base functionality. A number of custom providers is implemented to support the PMRV functionality, such as:

- Provide endpoint for OTP validation
- Store user's signature
- Keep user's last login time

== ClamAV
It is an open source 3rd party antivirus software. Its use is to scan all the uploaded files and detect any possible threats. More details can be found at
xref:interface-view:clamav-api.adoc[ClamAV API]

== PMRV Admin
A separate service has been implemented for camunda administration purposes.
This service exposes camunda web-app including cockpit and task list from where an administrator can view and take corrective actions in camunda workflows.

* https://camunda.com/platform-7/cockpit/[Cockpit]
* https://camunda.com/platform/tasklist/[Tasklist]
* https://github.com/camunda/camunda-bpm-platform/tree/master/webapps[GitHub]

https://docs.camunda.org/manual/latest/reference/rest/[Camunda Rest API]
 is also exposed (not publicly) and can be used to administer camunda.

== Static pages
=== Landing page
It is the entry point to the service. It contains instructions and other importand links and information. It should be always up and running and therefore it is deployed in a different server than the web application.

=== Maintenance page
This page is served by the reverse proxy wherever we need to put the system under scheduled maintenance. It is a static page with no dynamic behavior.
